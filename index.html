<!DOCTYPE html>
<html>
<head>
  <title>FARM 8OT - Plant Health & Pollination</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
      background-image: url('FARBOT4.jpeg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    
    .container {
      background: rgba(0, 0, 0, 0.8);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.1);
      max-width: 900px;
      width: 95%;
      text-align: center;
      backdrop-filter: blur(5px);
      position: relative;
    }
    
    /* Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
    .site-title {
      color: white;
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 5px;
      text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
      letter-spacing: 4px;
    }
    
    .site-subtitle {
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      margin-bottom: 30px;
      letter-spacing: 2px;
      font-style: italic;
    }
    
    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    .main-menu {
      display: flex;
      flex-direction: column;
      gap: 25px;
      align-items: center;
      padding: 20px;
    }
    
    .main-menu-button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 20px 50px;
      font-size: 24px;
      border-radius: 60px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
      min-width: 350px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    .main-menu-button:hover {
      background: #45a049;
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(76, 175, 80, 0.6);
    }
    
    .menu-description {
      color: rgba(255, 255, 255, 0.7);
      font-size: 16px;
      max-width: 500px;
      line-height: 1.6;
    }
    
    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
    .choice-screen {
      display: none;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }
    
    .action-button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      min-width: 200px;
    }
    
    .action-button:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
    }
    
    .upload-button {
      background: #FF9800;
    }
    
    .upload-button:hover {
      background: #F57C00;
    }
    
    .back-button-choice {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 10px 20px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .back-button-choice:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
    .webcam-container {
      margin: 20px auto;
      width: 320px;
      height: 320px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      display: none;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .webcam-container.active {
      display: flex;
    }
    
    /* Ø­Ø§ÙˆÙŠØ© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© */
    .upload-container {
      margin: 20px auto;
      width: 320px;
      height: 320px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      display: none;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      border: 2px dashed rgba(255, 255, 255, 0.3);
      position: relative;
    }
    
    .upload-container.active {
      display: flex;
    }
    
    .upload-preview {
      max-width: 100%;
      max-height: 100%;
      display: none;
    }
    
    .upload-preview.active {
      display: block;
    }
    
    #fileInput {
      display: none;
    }
    
    .file-label {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      padding: 15px 30px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      border: 2px dashed rgba(255, 255, 255, 0.3);
    }
    
    .file-label:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙƒØ´Ù */
    .results-container {
      display: none;
      margin-top: 30px;
    }
    
    .results-container.active {
      display: block;
    }
    
    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    
    .result-card {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 15px;
      color: white;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .result-card.plant {
      background: rgba(76, 175, 80, 0.15);
      border-color: #4CAF50;
    }
    
    .result-card.health {
      background: rgba(76, 175, 80, 0.15);
      border-color: #4CAF50;
    }
    
    .result-card.health.diseased {
      background: rgba(244, 67, 54, 0.15);
      border-color: #F44336;
    }
    
    .result-title {
      font-size: 16px;
      margin-bottom: 10px;
      opacity: 0.8;
    }
    
    .result-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .result-details {
      font-size: 14px;
      opacity: 0.7;
    }
    
    .health-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙ„Ù‚ÙŠØ­ - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© */
    .pollination-card {
      background: rgba(156, 39, 176, 0.2);
      border: 2px solid #9C27B0;
      border-radius: 20px;
      padding: 25px;
      margin-top: 25px;
      color: white;
      box-shadow: 0 0 20px rgba(156, 39, 176, 0.3);
    }
    
    .pollination-title {
      color: #E1BEE7;
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .pollination-detail {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin-bottom: 12px;
    }
    
    .frequency-badge {
      background: #4CAF50;
      padding: 8px 20px;
      border-radius: 50px;
      font-weight: bold;
      color: white;
      font-size: 16px;
    }
    
    .time-badge {
      background: #2196F3;
      padding: 8px 20px;
      border-radius: 50px;
      font-weight: bold;
      color: white;
    }
    
    .besttime-badge {
      background: #FF9800;
      padding: 8px 20px;
      border-radius: 50px;
      font-weight: bold;
      color: white;
    }
    
    .plant-emoji-big {
      font-size: 32px;
    }
    
    /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
    .notification {
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-left: 4px solid #4CAF50;
    }
    
    .notification.warning {
      border-left-color: #FFC107;
      background: rgba(255, 193, 7, 0.1);
    }
    
    .notification.danger {
      border-left-color: #F44336;
      background: rgba(244, 67, 54, 0.1);
    }
    
    .notification.pollination {
      border-left-color: #9C27B0;
      background: rgba(156, 39, 176, 0.1);
    }
    
    /* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    .back-menu-button {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(76, 175, 80, 0.2);
      color: white;
      border: 1px solid #4CAF50;
      padding: 10px 20px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .back-menu-button:hover {
      background: rgba(76, 175, 80, 0.4);
      transform: translateX(-3px);
    }
    
    .back-menu-button:before {
      content: "â†";
      font-size: 18px;
    }
    
    .controls-container {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .control-button {
      background: rgba(76, 175, 80, 0.2);
      color: white;
      border: 1px solid #4CAF50;
      padding: 10px 20px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .control-button:hover {
      background: rgba(76, 175, 80, 0.4);
    }
    
    .status-message {
      color: #4CAF50;
      margin: 10px 0;
      font-style: italic;
    }
    
    /* ØªØ®ØµÙŠØµ Ù„Ù„Ù†Ø¨Ø§ØªØ§Øª */
    .tomato-plant .plant-type {
      color: #FF5252;
    }
    
    .pepper-plant .plant-type {
      color: #4CAF50;
    }
    
    .potato-plant .plant-type {
      color: #FFB74D;
    }
    
    .zucchini-plant .plant-type {
      color: #FFC107;
    }
    
    .nothing-plant .plant-type {
      color: #90A4AE;
    }
    
    /* Ù†Ø§ÙØ°Ø© Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© */
    .solution-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .solution-modal.active {
      display: flex;
    }
    
    .solution-content {
      background: rgba(0, 0, 0, 0.9);
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid #4CAF50;
      box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
    }
    
    .solution-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .solution-title {
      color: #4CAF50;
      font-size: 24px;
      font-weight: bold;
    }
    
    .close-button {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .solution-section {
      margin-bottom: 25px;
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }
    
    .section-title {
      color: #4CAF50;
      font-size: 18px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
    <div class="site-title">FARM 8OT</div>
    <div class="site-subtitle">Teachable Machine</div>
    
    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="mainMenu" class="main-menu">
      <button class="main-menu-button" onclick="selectDiseasedMode()">
        ğŸ¦  Diseased Plants
      </button>
      <div class="menu-description">
        Detect plant diseases and get treatment solutions
      </div>
      
      <button class="main-menu-button" onclick="selectPollinationMode()" style="background: #9C27B0; box-shadow: 0 8px 25px rgba(156, 39, 176, 0.4);">
        ğŸµ Pollination Guide
      </button>
      <div class="menu-description">
        Identify plants and get optimal sound frequencies for pollination
      </div>
    </div>
    
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± -->
    <div id="choiceScreen" class="choice-screen">
      <p style="color: white; margin-bottom: 20px; font-size: 20px;" id="modeTitle">Choose detection method</p>
      <button class="action-button camera-button" onclick="chooseCamera()">ğŸ“· Camera Detection</button>
      <button class="action-button upload-button" onclick="chooseUpload()">ğŸ“ Upload Image</button>
      <button class="back-button-choice" onclick="backToMainMenu()">Main Menu</button>
    </div>
    
    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <div id="webcam-container" class="webcam-container">
      <div id="webcam-placeholder">Camera is starting...</div>
    </div>
    
    <!-- Ø­Ø§ÙˆÙŠØ© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© -->
    <div id="upload-container" class="upload-container">
      <div id="upload-placeholder" class="upload-placeholder">
        <label for="fileInput" class="file-label">
          Click to upload plant image
        </label>
        <input type="file" id="fileInput" accept="image/*" onchange="previewImage(event)">
      </div>
      <img id="upload-preview" class="upload-preview" alt="Preview">
    </div>
    
    <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© -->
    <div id="statusMessage" class="status-message"></div>
    
    <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div id="controlsContainer" class="controls-container" style="display: none;">
      <button class="control-button" onclick="restartDetection()">Restart</button>
      <button class="control-button" onclick="clearResults()">Clear</button>
      <button class="control-button" onclick="backToMainMenu()">Main Menu</button>
    </div>
    
    <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙƒØ´Ù -->
    <div id="resultsContainer" class="results-container">
      <div class="results-grid">
        <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ØªØ© -->
        <div id="plantResult" class="result-card plant">
          <div class="result-title">ğŸŒ± Plant Type</div>
          <div id="plantType" class="result-value plant-type">Detecting...</div>
          <div id="plantConfidence" class="result-details">Confidence: 0.00</div>
        </div>
        
        <!-- Ù†ØªÙŠØ¬Ø© ÙØ­Øµ Ø§Ù„ØµØ­Ø© Ø£Ùˆ Ø§Ù„ØªÙ„Ù‚ÙŠØ­ -->
        <div id="healthResult" class="result-card health">
          <div id="healthIcon" class="health-icon">ğŸ©º</div>
          <div class="result-title" id="resultSubTitle">ğŸ¥ Health Status</div>
          <div id="healthStatus" class="result-value">Checking...</div>
          <div id="healthConfidence" class="result-details">Confidence: 0.00</div>
        </div>
      </div>
      
      <!-- Ø²Ø± Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© (Ù„Ù„Ø£Ù…Ø±Ø§Ø¶) -->
      <div id="solutionButtonContainer" style="display: none; margin-top: 20px;">
        <button class="action-button" style="background: #4CAF50;" onclick="showSolution()">
          ğŸ”§ Show Treatment Solutions
        </button>
      </div>
      
      <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙ„Ù‚ÙŠØ­ - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ© -->
      <div id="pollinationCard" class="pollination-card" style="display: none;">
        <div class="pollination-title">
          <span class="plant-emoji-big" id="pollinationEmoji">ğŸµ</span>
          <span id="pollinationPlantName">Plant</span> Pollination Guide
        </div>
        <div id="pollinationContent"></div>
      </div>
      
      <!-- Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
      <div id="notification" class="notification">
        <div id="notificationText">Analysis in progress...</div>
      </div>
    </div>
  </div>
  
  <!-- Ù†Ø§ÙØ°Ø© Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© -->
  <div id="solutionModal" class="solution-modal">
    <div class="solution-content">
      <div class="solution-header">
        <h2 class="solution-title" id="solutionPlantTitle">Treatment Guide</h2>
        <button class="close-button" onclick="closeSolution()">âœ•</button>
      </div>
      <div class="solution-body" id="solutionContent"></div>
    </div>
  </div>

  <script type="text/javascript">
    // ============================================
    // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    // ============================================
    
    // 1. Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ØªØ© (Ù„Ù„Ø£Ù…Ø±Ø§Ø¶ - Tomato, Potato, Pepper)
    const DISEASE_PLANT_MODEL_URL = "https://farmbot1238.github.io/tomato/";
    
    // 2. Ù†Ù…ÙˆØ°Ø¬ ÙØ­Øµ Ø§Ù„ØµØ­Ø©
    const HEALTH_MODEL_URL = "https://teachablemachine.withgoogle.com/models/cFNqCcqIp/";
    
    // 3. Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ØªØ© (Ù„Ù„ØªÙ„Ù‚ÙŠØ­ - Tomato, Pepper, Zucchini)
    const POLLINATION_PLANT_MODEL_URL = "https://teachablemachine.withgoogle.com/models/BHRn8BcvX/";
    
    // ============================================
    // âœ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ„Ù‚ÙŠØ­ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© - Real Scientific Data
    // ============================================
    const pollinationData = {
      'tomato': {
        emoji: 'ğŸ…',
        name: 'Tomato',
        frequency: '200â€“400 Hz (Optimal: 250â€“300 Hz)',
        time: '5â€“10 seconds per flower, 30â€“60 seconds per plant',
        bestTime: '9:00 AM â€“ 11:30 AM',
        description: 'Tomato plants benefit from buzz pollination. Flowers are fully open and pollen is ready to release during this time. Best results achieved with consistent vibration exposure at 250â€“300 Hz.'
      },
      'pepper': {
        emoji: 'ğŸŒ¶ï¸',
        name: 'Pepper',
        frequency: '150â€“300 Hz',
        time: '5â€“8 seconds per flower, 20â€“40 seconds per plant',
        bestTime: '8:30 AM â€“ 11:00 AM',
        description: 'Pepper plants are self-pollinating but sound waves significantly increase fruit set. Less vibration-dependent than tomatoes, but acoustic stimulation at 150â€“300 Hz improves pollination success rate.'
      },
      'zucchini': {
        emoji: 'ğŸ¥’',
        name: 'Zucchini',
        frequency: '100â€“250 Hz',
        time: '10â€“15 seconds per female flower only',
        bestTime: '6:00 AM â€“ 9:00 AM âš ï¸ Female flower closes after this time',
        description: 'Requires cross-pollination between male and female flowers. A male flower must be open on the same day. Only the female flower needs vibration treatment. Pollination window is very narrow â€” apply early morning.'
      },
      'nothing': {
        emoji: 'ğŸŒ«ï¸',
        name: 'No Plant Detected',
        frequency: 'â€”',
        time: 'â€”',
        bestTime: 'â€”',
        description: 'Please capture a clear image of the plant leaf.'
      }
    };
    
    // Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶
    const diseaseSolutions = {
      'tomato': {
        title: "ğŸ… Tomato Disease Solutions",
        commonDiseases: ["Early Blight", "Late Blight", "Bacterial Spot", "Tomato Mosaic Virus"],
        treatments: [
          "Remove affected leaves immediately",
          "Apply copper-based fungicide",
          "Improve air circulation",
          "Water at soil level, not leaves",
          "Rotate crops annually"
        ],
        prevention: [
          "Use disease-resistant varieties",
          "Space plants 24-36 inches apart",
          "Avoid overhead watering",
          "Apply mulch around plants",
          "Clean garden tools regularly"
        ]
      },
      'potato': {
        title: "ğŸ¥” Potato Disease Solutions",
        commonDiseases: ["Potato Blight", "Common Scab", "Blackleg", "Potato Virus Y"],
        treatments: [
          "Remove and destroy infected plants",
          "Apply approved fungicides",
          "Improve soil drainage",
          "Avoid planting in infected soil for 3-4 years",
          "Use certified disease-free seed potatoes"
        ],
        prevention: [
          "Practice crop rotation",
          "Plant in well-drained soil",
          "Harvest potatoes when mature",
          "Store in cool, dry conditions",
          "Remove volunteer potatoes"
        ]
      },
      'pepper': {
        title: "ğŸŒ¶ï¸ Pepper Disease Solutions",
        commonDiseases: ["Bacterial Leaf Spot", "Phytophthora Blight", "Powdery Mildew", "Blossom End Rot"],
        treatments: [
          "Remove infected plants immediately",
          "Apply appropriate fungicides",
          "Maintain consistent soil moisture",
          "Apply calcium nitrate for blossom end rot",
          "Improve air circulation"
        ],
        prevention: [
          "Water early in the day",
          "Use drip irrigation",
          "Space plants 18-24 inches apart",
          "Avoid working with wet plants",
          "Use mulch to prevent soil splash"
        ]
      }
    };
    
    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    let plantModel, healthModel, pollinationModel, webcam;
    let currentMode = 'main';
    let currentAppMode = ''; // 'disease' or 'pollination'
    let uploadedImage = null;
    let plantModelLoaded = false;
    let healthModelLoaded = false;
    let pollinationModelLoaded = false;
    let currentDetection = null;
    let currentPlantType = '';
    let isPlantDiseased = false;
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.onload = function() {
      console.log("FRAM 8OT - Plant System Ready");
    };
    
    // Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¶Ø¹ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶
    function selectDiseasedMode() {
      currentAppMode = 'disease';
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('choiceScreen').style.display = 'flex';
      document.getElementById('modeTitle').innerHTML = 'ğŸ¦  Diseased Plants - Choose detection method';
      updateStatus("Loading disease detection models...");
      loadDiseaseModels();
    }
    
    // Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚ÙŠØ­
    function selectPollinationMode() {
      currentAppMode = 'pollination';
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('choiceScreen').style.display = 'flex';
      document.getElementById('modeTitle').innerHTML = 'ğŸµ Pollination Guide - Choose detection method';
      updateStatus("Loading pollination detection models...");
      loadPollinationModels();
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶
    async function loadDiseaseModels() {
      updateStatus("Loading plant detection model...");
      
      try {
        // ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ØªØ© (Ù„Ù„Ø£Ù…Ø±Ø§Ø¶)
        plantModel = await tmImage.load(
          DISEASE_PLANT_MODEL_URL + "model.json",
          DISEASE_PLANT_MODEL_URL + "metadata.json"
        );
        plantModelLoaded = true;
        console.log("âœ… Disease plant model loaded");
        
        updateStatus("Loading health check model...");
        healthModel = await tmImage.load(
          HEALTH_MODEL_URL + "model.json",
          HEALTH_MODEL_URL + "metadata.json"
        );
        healthModelLoaded = true;
        console.log("âœ… Health model loaded");
        
        updateStatus("âœ… Models loaded successfully!");
        
      } catch (err) {
        console.error("âŒ Error loading disease models:", err);
        updateStatus("âŒ Error loading models");
        alert("Failed to load disease detection models.");
      }
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªÙ„Ù‚ÙŠØ­
    async function loadPollinationModels() {
      updateStatus("Loading pollination plant model...");
      
      try {
        // ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¨ØªØ© (Ù„Ù„ØªÙ„Ù‚ÙŠØ­)
        pollinationModel = await tmImage.load(
          POLLINATION_PLANT_MODEL_URL + "model.json",
          POLLINATION_PLANT_MODEL_URL + "metadata.json"
        );
        pollinationModelLoaded = true;
        console.log("âœ… Pollination plant model loaded");
        updateStatus("âœ… Model loaded successfully!");
        
      } catch (err) {
        console.error("âŒ Error loading pollination model:", err);
        updateStatus("âŒ Error loading model");
        alert("Failed to load pollination detection model.");
      }
    }
    
    // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    function backToMainMenu() {
      document.getElementById('mainMenu').style.display = 'flex';
      document.getElementById('choiceScreen').style.display = 'none';
      document.getElementById('webcam-container').classList.remove('active');
      document.getElementById('upload-container').classList.remove('active');
      document.getElementById('controlsContainer').style.display = 'none';
      document.getElementById('resultsContainer').classList.remove('active');
      document.getElementById('solutionButtonContainer').style.display = 'none';
      document.getElementById('pollinationCard').style.display = 'none';
      
      currentAppMode = '';
      currentMode = 'main';
      updateStatus("");
      
      // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      if (webcam) {
        webcam.stop();
        webcam = null;
      }
    }
    
    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    function chooseCamera() {
      document.getElementById('choiceScreen').style.display = 'none';
      document.getElementById('webcam-container').classList.add('active');
      document.getElementById('upload-container').classList.remove('active');
      document.getElementById('controlsContainer').style.display = 'flex';
      document.getElementById('resultsContainer').classList.add('active');
      document.getElementById('solutionButtonContainer').style.display = 'none';
      document.getElementById('pollinationCard').style.display = 'none';
      currentMode = 'camera';
      updateStatus("ğŸ“· Camera mode - Detecting plant...");
      
      initCamera();
    }
    
    // Ø§Ø®ØªÙŠØ§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
    function chooseUpload() {
      document.getElementById('choiceScreen').style.display = 'none';
      document.getElementById('upload-container').classList.add('active');
      document.getElementById('webcam-container').classList.remove('active');
      document.getElementById('controlsContainer').style.display = 'flex';
      document.getElementById('resultsContainer').classList.add('active');
      document.getElementById('solutionButtonContainer').style.display = 'none';
      document.getElementById('pollinationCard').style.display = 'none';
      currentMode = 'upload';
      updateStatus("ğŸ“ Upload mode - Ready for image");
      
      document.getElementById('plantType').textContent = "Waiting for image...";
      if (currentAppMode === 'disease') {
        document.getElementById('healthStatus').textContent = "Will check after plant detection";
      } else {
        document.getElementById('healthStatus').textContent = "Ready to identify plant";
      }
    }
    
    async function initCamera() {
      if (currentAppMode === 'disease' && (!plantModelLoaded || !healthModelLoaded)) {
        updateStatus("Loading models, please wait...");
        await loadDiseaseModels();
      } else if (currentAppMode === 'pollination' && !pollinationModelLoaded) {
        updateStatus("Loading model, please wait...");
        await loadPollinationModels();
      }
      
      try {
        const flip = true;
        webcam = new tmImage.Webcam(320, 320, flip);
        await webcam.setup();
        await webcam.play();
        
        window.requestAnimationFrame(cameraLoop);
        
        const webcamContainer = document.getElementById('webcam-container');
        const canvasElements = webcamContainer.getElementsByTagName('canvas');
        if (canvasElements.length > 0) {
          for (let i = 0; i < canvasElements.length; i++) {
            webcamContainer.removeChild(canvasElements[i]);
          }
        }
        webcamContainer.appendChild(webcam.canvas);
        
        document.getElementById('webcam-placeholder').style.display = 'none';
        document.getElementById('plantType').textContent = "Detecting...";
        
      } catch (err) {
        console.error("âŒ Error starting webcam:", err);
        updateStatus("âŒ Error starting camera");
        alert("Failed to start webcam. Please check camera permissions.");
        backToMainMenu();
      }
    }
    
    async function cameraLoop() {
      if (currentMode === 'camera' && webcam) {
        webcam.update();
        await detectFromWebcam();
        window.requestAnimationFrame(cameraLoop);
      }
    }
    
    function previewImage(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('upload-preview');
        preview.src = e.target.result;
        preview.classList.add('active');
        uploadedImage = preview;
        
        document.getElementById('upload-placeholder').style.display = 'none';
        updateStatus("ğŸ” Analyzing uploaded image...");
        
        analyzeUploadedImage();
      }
      reader.readAsDataURL(file);
    }
    
    async function analyzeUploadedImage() {
      if (!uploadedImage) return;
      
      await new Promise(resolve => {
        if (uploadedImage.complete) {
          resolve();
        } else {
          uploadedImage.onload = resolve;
        }
      });
      
      await detectFromImage(uploadedImage);
    }
    
    async function detectFromWebcam() {
      if (!webcam) return;
      
      if (currentAppMode === 'disease' && plantModelLoaded) {
        try {
          const prediction = await plantModel.predict(webcam.canvas);
          processDiseaseDetection(prediction, webcam.canvas);
        } catch (err) {
          console.error("âŒ Error detecting from webcam:", err);
        }
      } else if (currentAppMode === 'pollination' && pollinationModelLoaded) {
        try {
          const prediction = await pollinationModel.predict(webcam.canvas);
          processPollinationDetection(prediction);
        } catch (err) {
          console.error("âŒ Error detecting from webcam:", err);
        }
      }
    }
    
    async function detectFromImage(imageElement) {
      if (currentAppMode === 'disease' && plantModelLoaded) {
        try {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 224;
          canvas.height = 224;
          ctx.drawImage(imageElement, 0, 0, 224, 224);
          
          const prediction = await plantModel.predict(canvas);
          processDiseaseDetection(prediction, canvas);
        } catch (err) {
          console.error("âŒ Error detecting from image:", err);
          alert("Error analyzing image.");
        }
      } else if (currentAppMode === 'pollination' && pollinationModelLoaded) {
        try {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 224;
          canvas.height = 224;
          ctx.drawImage(imageElement, 0, 0, 224, 224);
          
          const prediction = await pollinationModel.predict(canvas);
          processPollinationDetection(prediction);
        } catch (err) {
          console.error("âŒ Error detecting from image:", err);
          alert("Error analyzing image.");
        }
      }
    }
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒØ´Ù Ø§Ù„Ø£Ù…Ø±Ø§Ø¶
    async function processDiseaseDetection(prediction, sourceCanvas) {
      if (!prediction || prediction.length === 0) return;
      
      let bestPrediction = prediction[0];
      for (let i = 1; i < prediction.length; i++) {
        if (prediction[i].probability > bestPrediction.probability) {
          bestPrediction = prediction[i];
        }
      }
      
      updatePlantResult(bestPrediction.className, bestPrediction.probability);
      
      if (bestPrediction.className !== "There is nothing" && bestPrediction.probability > 0.3) {
        updateStatus("ğŸŒ¿ Plant detected! Checking health status...");
        await checkPlantHealth(sourceCanvas, bestPrediction.className);
      } else {
        updateHealthResult("No plant detected", 0);
        updateNotification("ğŸŒ«ï¸ No plant detected in the image.", "warning");
        document.getElementById('solutionButtonContainer').style.display = 'none';
      }
    }
    
    // ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ù†Ø¨ØªØ©
    async function checkPlantHealth(canvas, plantType) {
      if (!healthModelLoaded) {
        updateHealthResult("Health check unavailable", 0);
        return;
      }
      
      try {
        const healthPrediction = await healthModel.predict(canvas);
        
        let bestHealthPrediction = healthPrediction[0];
        for (let i = 1; i < healthPrediction.length; i++) {
          if (healthPrediction[i].probability > bestHealthPrediction.probability) {
            bestHealthPrediction = healthPrediction[i];
          }
        }
        
        updateHealthResult(bestHealthPrediction.className, bestHealthPrediction.probability);
        
        currentPlantType = plantType.toLowerCase();
        isPlantDiseased = bestHealthPrediction.className.toLowerCase().includes('diseased');
        
        if (bestHealthPrediction.className.toLowerCase().includes('healthy')) {
          updateNotification(`âœ… ${plantType} plant is healthy! Good condition.`, "success");
          document.getElementById('solutionButtonContainer').style.display = 'none';
        } else if (isPlantDiseased) {
          updateNotification(`âš ï¸ ${plantType} plant shows signs of disease! Needs attention.`, "danger");
          document.getElementById('solutionButtonContainer').style.display = 'block';
        }
        
        updateStatus("âœ… Analysis complete!");
        
      } catch (err) {
        console.error("âŒ Error checking plant health:", err);
        updateHealthResult("Health check failed", 0);
        updateNotification("âŒ Could not check plant health.", "warning");
        document.getElementById('solutionButtonContainer').style.display = 'none';
      }
    }
    
    // âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒØ´Ù Ø§Ù„ØªÙ„Ù‚ÙŠØ­ - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©
    function processPollinationDetection(prediction) {
      if (!prediction || prediction.length === 0) return;
      
      let bestPrediction = prediction[0];
      for (let i = 1; i < prediction.length; i++) {
        if (prediction[i].probability > bestPrediction.probability) {
          bestPrediction = prediction[i];
        }
      }
      
      const plantName = bestPrediction.className.toLowerCase();
      updatePlantResult(bestPrediction.className, bestPrediction.probability);
      
      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ„Ù‚ÙŠØ­
      document.getElementById('resultSubTitle').innerHTML = 'ğŸµ Pollination Guide';
      document.getElementById('healthIcon').innerHTML = 'ğŸµ';
      
      let plantKey = 'nothing';
      if (plantName.includes('tomato')) plantKey = 'tomato';
      else if (plantName.includes('pepper')) plantKey = 'pepper';
      else if (plantName.includes('zucchini')) plantKey = 'zucchini';
      
      const pollinationInfo = pollinationData[plantKey];
      
      // Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙ„Ù‚ÙŠØ­ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
      document.getElementById('pollinationCard').style.display = 'block';
      document.getElementById('pollinationEmoji').textContent = pollinationInfo.emoji;
      document.getElementById('pollinationPlantName').textContent = pollinationInfo.name;
      
      document.getElementById('pollinationContent').innerHTML = `
        <div class="pollination-detail">
          <span style="font-size: 18px;">ğŸµ Optimal Frequency</span>
          <span class="frequency-badge">${pollinationInfo.frequency}</span>
        </div>
        <div class="pollination-detail">
          <span style="font-size: 18px;">â±ï¸ Recommended Duration</span>
          <span class="time-badge">${pollinationInfo.time}</span>
        </div>
        <div class="pollination-detail">
          <span style="font-size: 18px;">ğŸŒ… Best Time</span>
          <span class="besttime-badge">${pollinationInfo.bestTime}</span>
        </div>
        <p style="margin-top: 20px; font-size: 16px; line-height: 1.6; color: rgba(255,255,255,0.9); background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
          ${pollinationInfo.description}
        </p>
      `;
      
      updateHealthResult("Plant Identified", bestPrediction.probability);
      updateNotification(`ğŸµ ${pollinationInfo.name} identified! Ready for acoustic pollination.`, "pollination");
      updateStatus("âœ… Plant identified successfully!");
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ø¨ØªØ©
    function updatePlantResult(plantType, confidence) {
      const plantResult = document.getElementById('plantResult');
      const plantTypeElement = document.getElementById('plantType');
      
      plantTypeElement.textContent = plantType;
      document.getElementById('plantConfidence').textContent = `Confidence: ${confidence.toFixed(2)}`;
      
      plantResult.classList.remove('tomato-plant', 'pepper-plant', 'potato-plant', 'zucchini-plant', 'nothing-plant');
      
      if (plantType.toLowerCase().includes('tomato')) {
        plantResult.classList.add('tomato-plant');
      } else if (plantType.toLowerCase().includes('pepper')) {
        plantResult.classList.add('pepper-plant');
      } else if (plantType.toLowerCase().includes('potato')) {
        plantResult.classList.add('potato-plant');
      } else if (plantType.toLowerCase().includes('zucchini')) {
        plantResult.classList.add('zucchini-plant');
      } else if (plantType.toLowerCase().includes('nothing')) {
        plantResult.classList.add('nothing-plant');
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù†ØªÙŠØ¬Ø© Ø§Ù„ØµØ­Ø©
    function updateHealthResult(healthStatus, confidence) {
      const healthResult = document.getElementById('healthResult');
      const healthIcon = document.getElementById('healthIcon');
      
      document.getElementById('healthStatus').textContent = healthStatus;
      document.getElementById('healthConfidence').textContent = `Confidence: ${confidence.toFixed(2)}`;
      
      if (healthStatus.toLowerCase().includes('healthy')) {
        healthIcon.textContent = "âœ…";
        healthResult.classList.remove('diseased');
      } else if (healthStatus.toLowerCase().includes('diseased')) {
        healthIcon.textContent = "âš ï¸";
        healthResult.classList.add('diseased');
      }
    }
    
    // Ø¹Ø±Ø¶ Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
    function showSolution() {
      let plantKey = '';
      if (currentPlantType.includes('tomato')) plantKey = 'tomato';
      else if (currentPlantType.includes('potato')) plantKey = 'potato';
      else if (currentPlantType.includes('pepper')) plantKey = 'pepper';
      
      if (!diseaseSolutions[plantKey]) {
        alert("No treatment information available.");
        return;
      }
      
      const solution = diseaseSolutions[plantKey];
      document.getElementById('solutionPlantTitle').textContent = solution.title;
      
      let content = `
        <div class="solution-section">
          <div class="section-title">ğŸ¦  Common Diseases</div>
          <ul style="color: white; list-style-type: none; padding-left: 0;">
            ${solution.commonDiseases.map(d => `<li style="padding: 5px 0;">â€¢ ${d}</li>`).join('')}
          </ul>
        </div>
        <div class="solution-section">
          <div class="section-title">ğŸ’Š Treatments</div>
          <ul style="color: white; list-style-type: none; padding-left: 0;">
            ${solution.treatments.map(t => `<li style="padding: 5px 0;">âœ… ${t}</li>`).join('')}
          </ul>
        </div>
        <div class="solution-section">
          <div class="section-title">ğŸ›¡ï¸ Prevention</div>
          <ul style="color: white; list-style-type: none; padding-left: 0;">
            ${solution.prevention.map(p => `<li style="padding: 5px 0;">âœ“ ${p}</li>`).join('')}
          </ul>
        </div>
      `;
      
      document.getElementById('solutionContent').innerHTML = content;
      document.getElementById('solutionModal').classList.add('active');
    }
    
    function closeSolution() {
      document.getElementById('solutionModal').classList.remove('active');
    }
    
    function updateNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      const notificationText = document.getElementById('notificationText');
      
      notificationText.textContent = message;
      notification.classList.remove('warning', 'danger', 'pollination');
      
      if (type === 'warning') notification.classList.add('warning');
      else if (type === 'danger') notification.classList.add('danger');
      else if (type === 'pollination') notification.classList.add('pollination');
    }
    
    function updateStatus(message) {
      document.getElementById('statusMessage').textContent = message;
    }
    
    function restartDetection() {
      if (currentMode === 'camera') {
        if (webcam) {
          webcam.stop();
          webcam = null;
        }
        initCamera();
      } else if (currentMode === 'upload') {
        document.getElementById('upload-preview').classList.remove('active');
        document.getElementById('upload-placeholder').style.display = 'block';
        document.getElementById('fileInput').value = '';
        uploadedImage = null;
        updatePlantResult("Waiting for image...", 0);
        if (currentAppMode === 'disease') {
          updateHealthResult("Will check after detection", 0);
          document.getElementById('solutionButtonContainer').style.display = 'none';
        } else {
          document.getElementById('pollinationCard').style.display = 'none';
        }
      }
    }
    
    function clearResults() {
      updatePlantResult("Detecting...", 0);
      if (currentAppMode === 'disease') {
        updateHealthResult("Checking...", 0);
        document.getElementById('solutionButtonContainer').style.display = 'none';
      } else {
        document.getElementById('pollinationCard').style.display = 'none';
      }
      updateNotification("Cleared results", "info");
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.getElementById('solutionModal').addEventListener('click', function(e) {
      if (e.target === this) closeSolution();
    });
  </script>
</body>
</html>
