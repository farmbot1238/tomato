<!DOCTYPE html>
<html>
<head>
  <title>Teachable Machine Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
      background-image: url('FARBOT4.jpeg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    
    .container {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.8);
      border: 2px solid rgba(255, 255, 255, 0.1);
      max-width: 800px;
      width: 90%;
      text-align: center;
      backdrop-filter: blur(5px);
      position: relative;
    }
    
    .title {
      color: white;
      margin-bottom: 30px;
      font-size: 28px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    .buttons-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .action-button {
      background: #4dccbd;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      min-width: 180px;
    }
    
    .action-button:hover {
      background: #2a9d8f;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    
    .upload-button {
      background: #FF9800;
    }
    
    .upload-button:hover {
      background: #F57C00;
    }
    
    .webcam-container {
      margin: 0 auto 30px;
      width: 320px;
      height: 320px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .upload-container {
      margin: 20px auto;
      width: 320px;
      height: 320px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      border: 2px dashed rgba(255, 255, 255, 0.3);
      position: relative;
      display: none;
    }
    
    .upload-container.active {
      display: flex;
    }
    
    .upload-preview {
      max-width: 100%;
      max-height: 100%;
      display: none;
    }
    
    .upload-preview.active {
      display: block;
    }
    
    #fileInput {
      display: none;
    }
    
    .file-label {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      padding: 15px 30px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      border: 2px dashed rgba(255, 255, 255, 0.3);
    }
    
    .file-label:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .label-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }
    
    .prediction-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      color: white;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      transition: all 0.3s ease;
      border-left: 5px solid transparent;
    }
    
    .prediction-class {
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    .prediction-prob {
      font-weight: bold;
      transition: all 0.3s ease;
    }
    
    #webcam-placeholder {
      color: rgba(255, 255, 255, 0.5);
      font-size: 16px;
    }
    
    .upload-placeholder {
      color: rgba(255, 255, 255, 0.5);
      font-size: 16px;
      text-align: center;
      padding: 20px;
    }
    
    /* زر الرجوع */
    .back-button {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 10px 20px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 16px;
      text-decoration: none;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .back-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(-3px);
    }
    
    .back-button:before {
      content: "←";
      font-size: 18px;
    }
    
    .mode-indicator {
      color: #4dccbd;
      font-size: 14px;
      margin-top: 10px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- زر الرجوع -->
    <a href="https://farmbot1238.github.io/Farm-bot-/" class="back-button">Back</a>
    
    <h1 class="title">FarmBot Plant Detection</h1>
    
    <div class="buttons-container">
      <button id="startButton" class="action-button" onclick="initWebcam()">Start Camera Detection</button>
      <button id="uploadButton" class="action-button upload-button" onclick="toggleUpload()">Upload Image for Detection</button>
    </div>
    
    <!-- حاوية الكاميرا -->
    <div id="webcam-container" class="webcam-container">
      <div id="webcam-placeholder">Camera will appear here after clicking Start</div>
    </div>
    
    <!-- حاوية رفع الصورة -->
    <div id="upload-container" class="upload-container">
      <div id="upload-placeholder" class="upload-placeholder">
        <label for="fileInput" class="file-label">
          Click to upload image
        </label>
        <input type="file" id="fileInput" accept="image/*" onchange="previewImage(event)">
      </div>
      <img id="upload-preview" class="upload-preview" alt="Preview">
    </div>
    
    <div id="mode-indicator" class="mode-indicator"></div>
    
    <div id="label-container" class="label-container">
      <!-- ستنشئها JavaScript تلقائياً -->
    </div>
  </div>

  <script type="text/javascript">
    // الرابط القديم
    const URL = "https://farmbot1238.github.io/tomato/";
    let model, webcam, labelContainer, maxPredictions;
    let currentMode = 'none'; // 'webcam' أو 'upload' أو 'none'
    let uploadedImage = null;

    async function initWebcam() {
      if (currentMode === 'webcam') return;
      
      currentMode = 'webcam';
      updateModeIndicator();
      
      const startButton = document.getElementById('startButton');
      const uploadButton = document.getElementById('uploadButton');
      startButton.textContent = 'Camera Active';
      uploadButton.textContent = 'Upload Image for Detection';
      
      document.getElementById('webcam-placeholder').style.display = 'none';
      document.getElementById('upload-container').classList.remove('active');
      
      // إخفاء الصورة المرفوعة إذا كانت موجودة
      document.getElementById('upload-preview').classList.remove('active');
      uploadedImage = null;

      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      try {
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        const flip = true;
        webcam = new tmImage.Webcam(320, 320, flip);
        await webcam.setup();
        await webcam.play();
        window.requestAnimationFrame(loop);

        const webcamContainer = document.getElementById('webcam-container');
        // إزالة الكاميرا القديمة إذا كانت موجودة
        if (webcamContainer.children.length > 1) {
          webcamContainer.removeChild(webcamContainer.lastChild);
        }
        webcamContainer.appendChild(webcam.canvas);
        
        // إنشاء العناصر تلقائياً حسب عدد الفئات
        labelContainer = document.getElementById('label-container');
        labelContainer.innerHTML = '';
        
        for (let i = 0; i < maxPredictions; i++) {
          const predictionDiv = document.createElement('div');
          predictionDiv.className = 'prediction-item';
          predictionDiv.innerHTML = `
            <span class="prediction-class">Loading...</span>
            <span class="prediction-prob">0.00</span>
          `;
          labelContainer.appendChild(predictionDiv);
        }

      } catch (err) {
        console.error("Error loading model:", err);
        alert("Failed to load model. Make sure your Teachable Machine model is published.");
        
        startButton.textContent = 'Start Camera Detection';
        currentMode = 'none';
        updateModeIndicator();
        document.getElementById('webcam-placeholder').style.display = 'block';
      }
    }

    function toggleUpload() {
      if (currentMode === 'upload') {
        // إذا كان في وضع الرفع بالفعل، ارجع للكاميرا
        initWebcam();
        return;
      }
      
      currentMode = 'upload';
      updateModeIndicator();
      
      const startButton = document.getElementById('startButton');
      const uploadButton = document.getElementById('uploadButton');
      startButton.textContent = 'Start Camera Detection';
      uploadButton.textContent = 'Upload Active';
      
      // إيقاف الكاميرا إذا كانت شغالة
      if (webcam) {
        webcam.stop();
        webcam = null;
      }
      
      document.getElementById('webcam-container').style.display = 'none';
      document.getElementById('upload-container').classList.add('active');
      
      // إعادة تعيين النتائج
      labelContainer = document.getElementById('label-container');
      labelContainer.innerHTML = '';
      
      // تحميل النموذج إذا لم يكن محملاً
      if (!model) {
        loadModel();
      }
    }

    async function loadModel() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      try {
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
      } catch (err) {
        console.error("Error loading model:", err);
        alert("Failed to load model.");
      }
    }

    function previewImage(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('upload-preview');
        preview.src = e.target.result;
        preview.classList.add('active');
        uploadedImage = preview;
        
        document.getElementById('upload-placeholder').style.display = 'none';
        
        // تحليل الصورة المرفوعة
        analyzeUploadedImage();
      }
      reader.readAsDataURL(file);
    }

    async function analyzeUploadedImage() {
      if (!model || !uploadedImage) return;
      
      // إنشاء العناصر تلقائياً حسب عدد الفئات
      labelContainer = document.getElementById('label-container');
      labelContainer.innerHTML = '';
      
      for (let i = 0; i < maxPredictions; i++) {
        const predictionDiv = document.createElement('div');
        predictionDiv.className = 'prediction-item';
        predictionDiv.innerHTML = `
          <span class="prediction-class">Analyzing...</span>
          <span class="prediction-prob">0.00</span>
        `;
        labelContainer.appendChild(predictionDiv);
      }
      
      // تحليل الصورة المرفوعة
      await predictFromImage(uploadedImage);
    }

    function updateModeIndicator() {
      const indicator = document.getElementById('mode-indicator');
      if (currentMode === 'webcam') {
        indicator.textContent = 'Mode: Live Camera Detection';
      } else if (currentMode === 'upload') {
        indicator.textContent = 'Mode: Image Upload Detection';
      } else {
        indicator.textContent = '';
      }
    }

    async function loop() {
      if (currentMode === 'webcam' && webcam) {
        webcam.update();
        await predictFromWebcam();
        window.requestAnimationFrame(loop);
      }
    }

    async function predictFromWebcam() {
      if (!model || !webcam) return;
      
      const prediction = await model.predict(webcam.canvas);
      updatePredictions(prediction);
    }

    async function predictFromImage(imageElement) {
      if (!model) return;
      
      // إنشاء canvas مؤقت للصورة
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 320;
      canvas.height = 320;
      
      // رسم الصورة على canvas
      ctx.drawImage(imageElement, 0, 0, 320, 320);
      
      // تحليل الصورة
      const prediction = await model.predict(canvas);
      updatePredictions(prediction);
    }

    function updatePredictions(prediction) {
      for (let i = 0; i < maxPredictions; i++) {
        // أخذ الاسم كما هو من النموذج
        const className = prediction[i].className;
        const probability = prediction[i].probability;
        const probPercent = Math.round(probability * 100); // تحويل لنسبة مئوية
        
        if (labelContainer.childNodes[i]) {
          const predictionClass = labelContainer.childNodes[i].querySelector('.prediction-class');
          const predictionProb = labelContainer.childNodes[i].querySelector('.prediction-prob');
          
          if (predictionClass && predictionProb) {
            predictionClass.textContent = className;
            predictionProb.textContent = probability.toFixed(2);
            
            // تطبيق الألوان حسب النسبة المئوية
            if (probPercent >= 70 && probPercent <= 100) {
              // أخضر للقيم العالية (70-100)
              predictionClass.style.color = '#4CAF50';
              predictionProb.style.color = '#4CAF50';
              labelContainer.childNodes[i].style.borderLeftColor = '#4CAF50';
            } else if (probPercent >= 40 && probPercent <= 69) {
              // أصفر للقيم المتوسطة (40-69)
              predictionClass.style.color = '#FFC107';
              predictionProb.style.color = '#FFC107';
              labelContainer.childNodes[i].style.borderLeftColor = '#FFC107';
            } else if (probPercent >= 1 && probPercent <= 39) {
              // أحمر للقيم المنخفضة (1-39)
              predictionClass.style.color = '#F44336';
              predictionProb.style.color = '#F44336';
              labelContainer.childNodes[i].style.borderLeftColor = '#F44336';
            } else {
              // أبيض للصفر (0)
              predictionClass.style.color = '#FFFFFF';
              predictionProb.style.color = '#FFFFFF';
              labelContainer.childNodes[i].style.borderLeftColor = 'transparent';
            }
          }
        }
      }
    }

    // تحميل النموذج عند بدء التحميل
    window.onload = function() {
      loadModel();
    };
  </script>
</body>
</html>
